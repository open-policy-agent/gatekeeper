name: disk-export
on:
  push:
    paths:
      - "pkg/export/dapr"
      - "pkg/export/disk"
      - "test/export/**"
  pull_request:
    paths:
      - "pkg/export/dapr"
      - "pkg/export/disk"
      - "test/export/**"
permissions: read-all

jobs:
  disk_test:
    name: "Disk export test"
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@cb605e52c26070c328afc4562f0b4ada7618a84e # v2.10.4
      with:
        egress-policy: audit

    - name: Check out code into the Go module directory
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

    - name: Bootstrap e2e
      run: |
        mkdir -p $GITHUB_WORKSPACE/bin
        echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH
        make e2e-bootstrap

    - name: Run e2e
      run: |
        make docker-buildx \
          IMG=gatekeeper-e2e:latest

        make e2e-build-load-externaldata-image

        kind load docker-image --name kind \
          gatekeeper-e2e:latest
        
        make e2e-reader-build-load-image
        
        make deploy IMG=gatekeeper-e2e:latest USE_LOCAL_IMG=true GENERATE_VAP=true GENERATE_VAPBINDING=true EXPORT_BACKEND=disk
        
        kubectl apply -f test/export/fake-reader/export_config.yaml
        make test-e2e ENABLE_EXPORT_TESTS=1

    - name: Save logs
      if: ${{ always() }}
      run: |
        kubectl logs -n gatekeeper-system -l control-plane=audit-controller -c manager --tail=-1 > logs-audit-manager.json
        kubectl logs -n gatekeeper-system -l control-plane=audit-controller -c go-sub --tail=-1 > logs-audit-export.json

    - name: Upload artifacts
      uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
      if: ${{ always() }}
      with:
        name: export-logs
        path: |
          logs-*.json

