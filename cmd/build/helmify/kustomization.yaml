namespace: '{{ .Release.Namespace }}'
  # these are defined in the chart values rather than hard-coded
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- ../../../config/default
labels:
- includeSelectors: true
  pairs:
    app: '{{ template "gatekeeper.name" . }}'
    chart: '{{ template "gatekeeper.name" . }}'
    heritage: '{{ .Release.Service }}'
    release: '{{ .Release.Name }}'
patches:
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: constrainttemplates.templates.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: constraintpodstatuses.status.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: constrainttemplatepodstatuses.status.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: mutatorpodstatuses.status.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: expansiontemplatepodstatuses.status.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: configpodstatuses.status.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: configs.config.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: syncsets.syncset.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: assignmetadata.mutations.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: assignimage.mutations.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: assign.mutations.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: modifyset.mutations.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: expansiontemplate.expansion.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: providers.externaldata.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: connections.connection.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: connectionpodstatuses.status.gatekeeper.sh
    version: v1
- path: labels_patch.yaml
  target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
    name: providerpodstatuses.status.gatekeeper.sh
    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/name
      value: "{{ .Values.audit.containerName }}"
    - op: remove
      path: /spec/template/spec/containers/0/resources/limits
    - op: remove
      path: /spec/template/spec/containers/0/resources/requests
    - op: remove
      path: /spec/template/spec/nodeSelector/kubernetes.io~1os
    - op: remove
      path: /spec/template/spec/containers/0/image
    - op: remove
      path: /spec/template/spec/containers/0/securityContext/allowPrivilegeEscalation
    - op: remove
      path: /spec/template/spec/containers/0/securityContext/capabilities
    - op: remove
      path: /spec/template/spec/containers/0/securityContext/readOnlyRootFilesystem
    - op: remove
      path: /spec/template/spec/containers/0/securityContext/runAsGroup
    - op: remove
      path: /spec/template/spec/containers/0/securityContext/runAsNonRoot
    - op: remove
      path: /spec/template/spec/containers/0/securityContext/runAsUser
    - op: remove
      path: /spec/template/spec/containers/0/securityContext/seccompProfile
  target:
    kind: Deployment
    name: gatekeeper-audit
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/name
      value: "{{ .Values.controllerManager.containerName }}"
    - op: remove
      path: /spec/template/spec/containers/0/resources/limits
    - op: remove
      path: /spec/template/spec/containers/0/resources/requests
    - op: remove
      path: /spec/template/spec/nodeSelector/kubernetes.io~1os
    - op: remove
      path: /spec/template/spec/affinity/podAntiAffinity
    - op: remove
      path: /spec/template/spec/containers/0/image
    - op: remove
      path: /spec/template/spec/containers/0/securityContext/allowPrivilegeEscalation
    - op: remove
      path: /spec/template/spec/containers/0/securityContext/capabilities
    - op: remove
      path: /spec/template/spec/containers/0/securityContext/readOnlyRootFilesystem
    - op: remove
      path: /spec/template/spec/containers/0/securityContext/runAsGroup
    - op: remove
      path: /spec/template/spec/containers/0/securityContext/runAsNonRoot
    - op: remove
      path: /spec/template/spec/containers/0/securityContext/runAsUser
    - op: remove
      path: /spec/template/spec/containers/0/securityContext/seccompProfile
  target:
    kind: Deployment
    name: gatekeeper-controller-manager
- patch: |-
    - op: remove
      path: /spec/ports
  target:
    kind: Service
    name: webhook-service
- patch: |-
    - op: replace
      path: /metadata/name
      value: "{{ .Values.validatingWebhookName }}"
    - op: replace
      path: /webhooks/0/clientConfig
      value: { "HELMSUBST_VALIDATING_WEBHOOK_CLIENT_CONFIG": "" }
  target:
    kind: ValidatingWebhookConfiguration
    name: gatekeeper-validating-webhook-configuration
- patch: "- op: replace\n  path: /metadata/name\n  value: \"{{ .Values.mutatingWebhookName
    }}\"\n- op: replace\n  path: /webhooks/0/clientConfig\n  value: { \"HELMSUBST_MUTATING_WEBHOOK_CLIENT_CONFIG\":
    \"\" }\n  "
  target:
    kind: MutatingWebhookConfiguration
    name: gatekeeper-mutating-webhook-configuration
- path: kustomize-for-helm.yaml
- path: delete-ports.yaml
